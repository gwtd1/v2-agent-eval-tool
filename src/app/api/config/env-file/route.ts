import { NextRequest, NextResponse } from 'next/server';
import { writeFile } from 'fs/promises';
import { join } from 'path';
import { detectEnvironment } from '@/utils/environmentDetection';

/**
 * Create or update .env.local file with API configuration
 */
export async function POST(request: NextRequest) {
  try {
    const { apiKey, baseUrl } = await request.json();

    // Check if we're in an environment that supports file writing
    const environment = detectEnvironment();

    if (!environment.canWriteEnvFile) {
      return NextResponse.json(
        {
          error: 'Cannot create .env.local file in this environment',
          platform: environment.platform,
          recommendation: 'Use environment variables or localStorage instead'
        },
        { status: 400 }
      );
    }

    if (!apiKey) {
      return NextResponse.json(
        { error: 'API key is required' },
        { status: 400 }
      );
    }

    // Determine the base URL to use
    const tdLlmBaseUrl = baseUrl || 'https://llm-api.us01.treasuredata.com';

    // Create the .env.local content
    const envContent = `# Treasure Data Configuration - Generated by Agent Eval Tool
# Generated on: ${new Date().toISOString()}

# TDX Configuration
TD_API_KEY=${apiKey}
TD_LLM_BASE_URL=${tdLlmBaseUrl}

# Feature #4: API Key Configuration Popup
# Enables direct API calls instead of TDX CLI (3-5x faster)
# Falls back to TDX CLI if API fails or set to false
USE_DIRECT_API=true

# Database
DATABASE_PATH=./data/evaluations.db

# App
NODE_ENV=development

# Note: This file was automatically created by the Agent Eval Tool setup wizard.
# You can modify these values manually if needed.
`;

    // Write the file to the project root
    const envFilePath = join(process.cwd(), '.env.local');

    try {
      await writeFile(envFilePath, envContent, 'utf8');

      return NextResponse.json({
        success: true,
        filePath: '.env.local',
        message: 'Environment file created successfully',
        timestamp: new Date().toISOString(),
      });

    } catch (writeError) {
      console.error('[API] Failed to write .env.local file:', writeError);

      return NextResponse.json(
        {
          error: 'Failed to create .env.local file',
          details: writeError instanceof Error ? writeError.message : 'Unknown write error',
          suggestion: 'Please check file permissions and try again'
        },
        { status: 500 }
      );
    }

  } catch (error) {
    console.error('[API] Env file creation error:', error);

    return NextResponse.json(
      { error: 'Failed to process environment file request' },
      { status: 500 }
    );
  }
}